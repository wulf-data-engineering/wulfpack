name: Dependabot auto-merge
on:
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          pull-request-number: ${{ inputs.pr_number || github.event.pull_request.number }}
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Verify Commits
        id: commit_check
        run: |
          PR_NUM="${{ inputs.pr_number || github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          
          RAW_DATA=$(gh api repos/$REPO/pulls/$PR_NUM/commits --jq '.[] | .commit.author.name, .commit.committer.name, .author.login, .committer.login')
          
          if [ -z "$RAW_DATA" ] || [ "$RAW_DATA" == "[]" ]; then
            echo "PROCEED=false" >> $GITHUB_ENV
            exit 0
          fi

          HUMANS=$(echo "$RAW_DATA" | grep -vE "^(dependabot\[bot\]|dependabot|GitHub|web-flow|null|)$" | sort -u || true)
          
          if [ -n "$HUMANS" ]; then
            echo "::warning title=Security Alert::Human interference detected: $HUMANS"
            echo "PROCEED=false" >> $GITHUB_ENV
          else
            echo "PROCEED=true" >> $GITHUB_ENV
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Security Cleanup
        if: env.PROCEED == 'false'
        run: |
          PR_NUM="${{ inputs.pr_number || github.event.pull_request.number }}"
          PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUM"

          echo "Human detected. Cleaning up bot state for $PR_URL"

          # 1. Disable Auto-merge
          gh pr merge --disable-auto "$PR_URL" || echo "Auto-merge was not enabled."

          # 2. Dismiss Bot Approvals
          # Finds the ID of an 'APPROVED' review from the bot
          EXISTING_APPROVAL=$(gh pr view "$PR_URL" --json reviews --jq '.reviews[] | select(.state=="APPROVED" and .author.login=="github-actions") | .id' | head -n 1)
          
          if [ -n "$EXISTING_APPROVAL" ]; then
            gh pr review "$PR_URL" --dismiss -m "Security: Non-bot commits detected. Auto-merge disabled and approval withdrawn."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve and Merge
        if: env.PROCEED == 'true' && steps.metadata.outputs.update-type != 'version-update:semver-major'
        run: |
          PR_URL="${{ inputs.pr_number && format('https://github.com/{0}/pull/{1}', github.repository, inputs.pr_number) || github.event.pull_request.html_url }}"
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --squash "$PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}