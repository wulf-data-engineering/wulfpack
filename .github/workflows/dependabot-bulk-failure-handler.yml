# This workflow is necessary to implement a tiered update strategy.
# If the daily bulk update (scheduled at 08:00) fails CI, this workflow closes the PR.
# Closing the PR allows Dependabot to fall back to the granular updates (scheduled at 09:00),
# ensuring that individual package updates can still pass even if the bulk update fails.
name: Dependabot Bulk Failure Handler
on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: ["dependabot/**"]

jobs:
  close-on-failure:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' && contains(github.event.workflow_run.head_branch, 'bulk')
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Close Failed Bulk PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the PR associated with this run
          PR_DATA=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number,labels,author --limit 1)
          PR_NUMBER=$(echo $PR_DATA | jq -r '.[0].number // empty')
          PR_AUTHOR=$(echo $PR_DATA | jq -r '.[0].author.login // empty')
          # Check if the "bulk" label exists in the labels array
          HAS_BULK_LABEL=$(echo $PR_DATA | jq -r '.[0].labels[] | select(.name == "bulk") | .name // empty')

          if [[ "$PR_AUTHOR" == "dependabot[bot]" ]] && [[ "$HAS_BULK_LABEL" == "bulk" ]]; then
            echo "Closing failed bulk PR #$PR_NUMBER to allow tiered fallbacks."
            gh pr comment $PR_NUMBER --body "Bulk update failed CI. Closing this PR to allow more granular updates in the next scheduled window."
            gh pr close $PR_NUMBER --delete-branch
          else
            echo "Skipping: Not a Dependabot bulk PR (Author: $PR_AUTHOR, Bulk Label: $HAS_BULK_LABEL)"
          fi
